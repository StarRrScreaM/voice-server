<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Test Voice</title>
</head>
<body>
<h1>Простой тест микрофона</h1>
<button id="startBtn">Начать</button>
<div id="log"></div>

<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<script>
let socket = io('https://voice-server-w83t.onrender.com');
let localStream;
let pc;
let remoteAudio = new Audio();
remoteAudio.autoplay = true;

document.getElementById('startBtn').onclick = async () => {
  // Получаем микрофон
  localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
  
  // Создаём P2P соединение
  pc = new RTCPeerConnection({ iceServers:[{ urls:'stun:stun.l.google.com:19302' }] });
  localStream.getTracks().forEach(track => pc.addTrack(track, localStream));

  pc.ontrack = e => {
    remoteAudio.srcObject = e.streams[0];
    document.getElementById('log').innerText = 'Получен поток от другого участника!';
  };

  pc.onicecandidate = e => {
    if(e.candidate) socket.emit('ice', { candidate:e.candidate });
  };

  // Создаём offer
  const offer = await pc.createOffer();
  await pc.setLocalDescription(offer);
  socket.emit('offer', { offer });

  socket.on('offer', async data => {
    await pc.setRemoteDescription(data.offer);
    const answer = await pc.createAnswer();
    await pc.setLocalDescription(answer);
    socket.emit('answer', { answer });
  });

  socket.on('answer', async data => {
    await pc.setRemoteDescription(data.answer);
  });

  socket.on('ice', async data => {
    if(data.candidate) await pc.addIceCandidate(data.candidate);
  });

  document.getElementById('log').innerText = 'Микрофон подключён, ждём другого пользователя...';
};
</script>
</body>
</html>
