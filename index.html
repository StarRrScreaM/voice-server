<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Voice Chat - Discord-like</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #36393f;
      color: #dcddde;
      height: 100vh;
      display: flex;
      overflow: hidden;
    }

    .sidebar {
      width: 240px;
      background: #2f3136;
      display: flex;
      flex-direction: column;
      padding: 20px;
      overflow-y: auto;
    }

    .logo {
      font-size: 20px;
      font-weight: bold;
      color: #fff;
      margin-bottom: 20px;
    }

    .room-section {
      margin-bottom: 20px;
    }

    .room-section h3 {
      font-size: 12px;
      text-transform: uppercase;
      color: #8e9297;
      margin-bottom: 10px;
    }

    .name-input {
      width: 100%;
      padding: 10px;
      background: #202225;
      border: none;
      border-radius: 4px;
      color: #fff;
      margin-bottom: 10px;
    }

    .btn {
      width: 100%;
      padding: 12px;
      background: #5865f2;
      border: none;
      border-radius: 4px;
      color: #fff;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s;
      margin-bottom: 10px;
    }

    .btn:hover {
      background: #4752c4;
    }

    .btn:disabled {
      background: #4f545c;
      cursor: not-allowed;
    }

    .btn-danger {
      background: #ed4245;
    }

    .btn-danger:hover {
      background: #c03537;
    }

    .mic-test {
      margin-bottom: 20px;
      padding: 15px;
      background: #202225;
      border-radius: 4px;
    }

    .mic-test h4 {
      font-size: 12px;
      color: #8e9297;
      margin-bottom: 10px;
    }

    .visualizer {
      display: flex;
      align-items: flex-end;
      justify-content: center;
      gap: 3px;
      height: 60px;
      margin-bottom: 10px;
    }

    .bar {
      width: 4px;
      background: #5865f2;
      border-radius: 2px;
      transition: height 0.1s ease;
      min-height: 2px;
    }

    .mic-level {
      font-size: 11px;
      color: #8e9297;
      text-align: center;
    }

    .users-list {
      margin-top: 20px;
    }

    .users-list h3 {
      font-size: 12px;
      text-transform: uppercase;
      color: #8e9297;
      margin-bottom: 10px;
    }

    .user-item {
      padding: 10px;
      background: #202225;
      border-radius: 4px;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .user-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: #5865f2;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      color: #fff;
      flex-shrink: 0;
    }

    .user-info {
      flex: 1;
      min-width: 0;
    }

    .user-name {
      font-weight: 600;
      color: #fff;
      margin-bottom: 4px;
      font-size: 14px;
    }
    
    .user-status {
      font-size: 11px;
      color: #8e9297;
      margin-top: 2px;
    }

    .user-visualizer {
      display: flex;
      align-items: flex-end;
      gap: 2px;
      height: 20px;
    }

    .user-bar {
      width: 3px;
      background: #43b581;
      border-radius: 1px;
      transition: height 0.1s ease;
      min-height: 1px;
    }

    .main-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-width: 0;
    }

    .chat-area {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: #36393f;
    }

    .messages {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
    }

    .message {
      margin-bottom: 15px;
      display: flex;
      gap: 15px;
    }

    .message-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: #5865f2;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      color: #fff;
      flex-shrink: 0;
    }

    .message-content {
      flex: 1;
      min-width: 0;
    }

    .message-header {
      display: flex;
      gap: 10px;
      align-items: baseline;
      margin-bottom: 5px;
    }

    .message-author {
      font-weight: 600;
      color: #fff;
    }

    .message-time {
      font-size: 12px;
      color: #72767d;
    }

    .message-text {
      color: #dcddde;
      word-wrap: break-word;
    }

    .input-area {
      padding: 20px;
      background: #40444b;
      display: flex;
      gap: 10px;
    }

    .message-input {
      flex: 1;
      padding: 12px;
      background: #2f3136;
      border: none;
      border-radius: 4px;
      color: #fff;
      font-size: 16px;
    }

    .message-input:focus {
      outline: none;
    }

    .send-btn {
      padding: 12px 24px;
      background: #5865f2;
      border: none;
      border-radius: 4px;
      color: #fff;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s;
    }

    .send-btn:hover {
      background: #4752c4;
    }

    .status {
      padding: 10px;
      background: #202225;
      text-align: center;
      font-size: 14px;
      color: #8e9297;
    }

    .status.connected {
      color: #43b581;
    }

    .status.error {
      color: #ed4245;
    }

    .voice-controls {
      padding: 15px;
      background: #2f3136;
      display: flex;
      gap: 15px;
      align-items: center;
      justify-content: center;
      flex-wrap: wrap;
    }

    .mic-btn {
      padding: 12px 24px;
      background: #ed4245;
      border: none;
      border-radius: 4px;
      color: #fff;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s;
    }

    .mic-btn.muted {
      background: #43b581;
    }

    .mic-btn:hover {
      opacity: 0.8;
    }

    .noise-suppression-toggle {
      display: flex;
      align-items: center;
      gap: 8px;
      color: #dcddde;
      font-size: 14px;
    }

    .toggle-switch {
      position: relative;
      width: 44px;
      height: 24px;
      background: #4f545c;
      border-radius: 12px;
      cursor: pointer;
      transition: background 0.2s;
    }

    .toggle-switch.active {
      background: #5865f2;
    }

    .toggle-switch::after {
      content: '';
      position: absolute;
      width: 18px;
      height: 18px;
      background: #fff;
      border-radius: 50%;
      top: 3px;
      left: 3px;
      transition: transform 0.2s;
    }

    .toggle-switch.active::after {
      transform: translateX(20px);
    }

    @media (max-width: 768px) {
      body {
        flex-direction: column;
        height: 100vh;
        overflow: hidden;
      }

      .sidebar {
        width: 100%;
        height: var(--sidebar-height, 40vh);
        max-height: 70vh;
        min-height: 30vh;
        padding: 15px;
        overflow-y: auto;
        transition: height 0.1s ease;
      }

      .sidebar-resizer {
        width: 100%;
        height: 8px;
        background: #2f3136;
        border-top: 1px solid #202225;
        border-bottom: 1px solid #202225;
        cursor: ns-resize;
        touch-action: none;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #8e9297;
        font-size: 12px;
        transition: all 0.2s ease;
        position: relative;
      }

      .sidebar-resizer::before {
        content: '‚ãÆ‚ãÆ';
        transform: rotate(90deg);
        transition: all 0.2s ease;
      }

      .sidebar-resizer.reset-ready::before {
        content: '‚Üª';
        transform: none;
      }

      .sidebar-resizer:hover {
        background: #36393f;
        color: #dcddde;
      }

      .sidebar-resizer:active,
      .sidebar-resizer.active {
        background: #5865f2;
        color: #fff;
      }

      .sidebar-resizer::after {
        content: '';
        position: absolute;
        left: 50%;
        top: 50%;
        transform: translate(-50%, -50%);
        width: 40px;
        height: 2px;
        background: currentColor;
        border-radius: 1px;
        opacity: 0.5;
      }

      /* –î–æ–±–∞–≤–ª—è–µ–º –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –¥–≤–æ–π–Ω–æ–≥–æ –∫–ª–∏–∫–∞ –¥–ª—è —Å–±—Ä–æ—Å–∞ –∫ —É–º–æ–ª—á–∞–Ω–∏—é */
      .sidebar-resizer.reset-ready {
        background: #ed4245;
        color: #fff;
      }

      .logo {
        font-size: 18px;
        margin-bottom: 15px;
      }

      .room-section {
        margin-bottom: 15px;
      }

      .name-input, .btn {
        padding: 10px;
        font-size: 14px;
      }

      .mic-test {
        padding: 10px;
        margin-bottom: 15px;
      }

      .visualizer {
        height: 50px;
      }

      .users-list {
        margin-top: 15px;
      }

      .user-item {
        padding: 8px;
        margin-bottom: 6px;
      }

      .user-avatar {
        width: 35px;
        height: 35px;
        font-size: 14px;
      }

      .user-name {
        font-size: 13px;
      }

      .user-status {
        font-size: 10px;
      }

      .main-content {
        flex: 1;
        min-height: 0;
        display: flex;
        flex-direction: column;
      }

      .status {
        padding: 8px;
        font-size: 12px;
      }

      .messages {
        padding: 15px;
        font-size: 14px;
      }

      .message {
        margin-bottom: 12px;
        gap: 10px;
      }

      .message-avatar {
        width: 35px;
        height: 35px;
        font-size: 14px;
      }

      .input-area {
        padding: 15px;
        gap: 8px;
      }

      .message-input {
        padding: 10px;
        font-size: 14px;
      }

      .send-btn {
        padding: 10px 20px;
        font-size: 14px;
      }

      .voice-controls {
        padding: 12px;
        gap: 10px;
        flex-wrap: wrap;
      }

      .mic-btn {
        padding: 10px 20px;
        font-size: 14px;
      }

      .noise-suppression-toggle {
        font-size: 12px;
      }

      .toggle-switch {
        width: 40px;
        height: 22px;
      }

      .toggle-switch::after {
        width: 16px;
        height: 16px;
        top: 3px;
        left: 3px;
      }

      .toggle-switch.active::after {
        transform: translateX(18px);
      }
    }

    @media (max-width: 480px) {
      .sidebar {
        max-height: 35vh;
        padding: 10px;
      }

      .logo {
        font-size: 16px;
      }

      .user-item {
        padding: 6px;
      }

      .user-avatar {
        width: 30px;
        height: 30px;
      }

      .voice-controls {
        flex-direction: column;
        align-items: stretch;
      }

      .mic-btn {
        width: 100%;
      }

      .noise-suppression-toggle {
        width: 100%;
        justify-content: space-between;
      }
    }

    ::-webkit-scrollbar {
      width: 8px;
    }

    ::-webkit-scrollbar-track {
      background: #2f3136;
    }

    ::-webkit-scrollbar-thumb {
      background: #202225;
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #1a1c1f;
    }

    /* –°–∫—Ä—ã–≤–∞–µ–º —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å –Ω–∞ –±–æ–ª—å—à–∏—Ö —ç–∫—Ä–∞–Ω–∞—Ö */
    @media (min-width: 769px) {
      .sidebar-resizer {
        display: none !important;
      }
    }
  </style>
</head>
<body>
  <div class="sidebar">
    <div class="logo">üé§ Voice Chat</div>

    <div class="room-section">
      <h3>–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ</h3>
      <input type="text" id="nameInput" class="name-input" placeholder="–í–∞—à–µ –∏–º—è" value="">
      <button id="joinBtn" class="btn">–í–æ–π—Ç–∏</button>
      <button id="leaveBtn" class="btn btn-danger" disabled>–í—ã–π—Ç–∏</button>
    </div>

    <div class="mic-test" id="micTest" style="display: none;">
      <h4>–¢–µ—Å—Ç –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞</h4>
      <div class="visualizer" id="micVisualizer"></div>
      <div class="mic-level" id="micLevel">–£—Ä–æ–≤–µ–Ω—å: 0%</div>
    </div>

    <div class="users-list">
      <h3>–£—á–∞—Å—Ç–Ω–∏–∫–∏</h3>
      <div id="usersList"></div>
    </div>
  </div>

  <!-- –†–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å –¥–ª—è –º–æ–±–∏–ª—å–Ω–æ–π –≤–µ—Ä—Å–∏–∏ -->
  <div class="sidebar-resizer" id="sidebarResizer" style="display: none;"></div>

  <div class="main-content">
    <div class="status" id="status">–ù–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ</div>
    
    <div class="chat-area">
      <div class="messages" id="messages"></div>
      <div class="input-area">
        <input type="text" id="messageInput" class="message-input" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." disabled>
        <button id="sendBtn" class="send-btn" disabled>–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
      </div>
    </div>

    <div class="voice-controls">
      <button id="micBtn" class="mic-btn" disabled>üé§ –ú–∏–∫—Ä–æ—Ñ–æ–Ω</button>
      <div class="noise-suppression-toggle">
        <span>–®—É–º–æ–ø–æ–¥–∞–≤–ª–µ–Ω–∏–µ</span>
        <div class="toggle-switch" id="noiseSuppressionToggle"></div>
      </div>
    </div>
  </div>

<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<script>
    const socket = io('https://voice-server-w83t.onrender.com');
    let currentUserId = null; // ID —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

    // Debug mode - –ª–æ–≥–∏—Ä—É–µ–º –≤—Å–µ –≤–∞–∂–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è
    const DEBUG = true;
    function debugLog(...args) {
      if (DEBUG) console.log('üîß', ...args);
    }

    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    function loadSavedUsername() {
      try {
        const savedName = localStorage.getItem('voiceChatUsername');
        if (savedName && savedName.trim()) {
          nameInput.value = savedName;
          debugLog('Loaded saved username:', savedName);
        }
      } catch (e) {
        console.warn('Could not load saved username:', e);
      }
    }

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    function saveUsername(username) {
      try {
        localStorage.setItem('voiceChatUsername', username);
        debugLog('Saved username:', username);
      } catch (e) {
        console.warn('Could not save username:', e);
      }
    }

    // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –≤—ã—Å–æ—Ç–æ–π —Å–∞–π–¥–±–∞—Ä–∞
    function loadSidebarHeight() {
      try {
        const savedHeight = localStorage.getItem('voiceChatSidebarHeight');
        if (savedHeight) {
          document.documentElement.style.setProperty('--sidebar-height', savedHeight);
          debugLog('Loaded sidebar height:', savedHeight);
        }
      } catch (e) {
        console.warn('Could not load sidebar height:', e);
      }
    }

    function saveSidebarHeight(height) {
      try {
        localStorage.setItem('voiceChatSidebarHeight', height);
        debugLog('Saved sidebar height:', height);
      } catch (e) {
        console.warn('Could not save sidebar height:', e);
      }
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –º–æ–±–∏–ª—å–Ω–æ–π –≤–µ—Ä—Å–∏–∏
    function isMobile() {
      return window.innerWidth <= 768;
    }

    // –õ–æ–≥–∏–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞ —Å–∞–π–¥–±–∞—Ä–∞
    function initSidebarResizer() {
      const resizer = document.getElementById('sidebarResizer');
      const sidebar = document.querySelector('.sidebar');

      if (!resizer || !sidebar) return;

      let isResizing = false;
      let startY = 0;
      let startHeight = 0;

      function startResize(e) {
        isResizing = true;
        startY = e.touches ? e.touches[0].clientY : e.clientY;
        startHeight = sidebar.offsetHeight;
        resizer.classList.add('active');
        document.body.style.userSelect = 'none';
        debugLog('Started resizing sidebar');
      }

      function resize(e) {
        if (!isResizing) return;

        const clientY = e.touches ? e.touches[0].clientY : e.clientY;
        const deltaY = clientY - startY;
        const newHeight = Math.max(200, Math.min(500, startHeight + deltaY)); // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –≤—ã—Å–æ—Ç—ã

        sidebar.style.height = `${newHeight}px`;
        debugLog('Resizing sidebar to:', newHeight);
      }

      function stopResize() {
        if (!isResizing) return;

        isResizing = false;
        resizer.classList.remove('active');
        document.body.style.userSelect = '';

        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–æ–≤—É—é –≤—ã—Å–æ—Ç—É
        const currentHeight = sidebar.offsetHeight;
        const heightPercent = (currentHeight / window.innerHeight) * 100;
        document.documentElement.style.setProperty('--sidebar-height', `${heightPercent}vh`);
        saveSidebarHeight(`${heightPercent}vh`);

        debugLog('Finished resizing sidebar to:', heightPercent + 'vh');
      }

      // –§—É–Ω–∫—Ü–∏—è —Å–±—Ä–æ—Å–∞ –≤—ã—Å–æ—Ç—ã –∫ –∑–Ω–∞—á–µ–Ω–∏—é –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
      function resetSidebarHeight() {
        const defaultHeight = '40vh';
        document.documentElement.style.setProperty('--sidebar-height', defaultHeight);
        sidebar.style.height = defaultHeight;
        saveSidebarHeight(defaultHeight);
        debugLog('Reset sidebar height to default:', defaultHeight);
      }

      // –î–≤–æ–π–Ω–æ–π –∫–ª–∏–∫ –¥–ª—è —Å–±—Ä–æ—Å–∞
      let clickTimeout;
      resizer.addEventListener('click', () => {
        if (clickTimeout) {
          clearTimeout(clickTimeout);
          clickTimeout = null;
          // –î–≤–æ–π–Ω–æ–π –∫–ª–∏–∫ - —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—ã—Å–æ—Ç—É
          resetSidebarHeight();
          resizer.classList.remove('reset-ready');
        } else {
          // –ü–µ—Ä–≤—ã–π –∫–ª–∏–∫ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–¥—Å–∫–∞–∑–∫—É
          clickTimeout = setTimeout(() => {
            clickTimeout = null;
            resizer.classList.remove('reset-ready');
          }, 300);
          resizer.classList.add('reset-ready');
        }
      });

      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –º—ã—à–∏
      resizer.addEventListener('mousedown', (e) => {
        // –ï—Å–ª–∏ —ç—Ç–æ –Ω–µ –¥–≤–æ–π–Ω–æ–π –∫–ª–∏–∫, –Ω–∞—á–∏–Ω–∞–µ–º resize
        if (!clickTimeout) {
          startResize(e);
        }
      });
      document.addEventListener('mousemove', resize);
      document.addEventListener('mouseup', stopResize);

      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è touch
      resizer.addEventListener('touchstart', (e) => {
        // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –∫–æ–Ω—Ñ–ª–∏–∫—Ç —Å –¥–≤–æ–π–Ω—ã–º –∫–ª–∏–∫–æ–º
        if (e.touches.length === 1) {
          startResize(e);
        }
      }, { passive: false });
      document.addEventListener('touchmove', resize, { passive: false });
      document.addEventListener('touchend', stopResize);
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    document.addEventListener('DOMContentLoaded', () => {
      loadSavedUsername();
      loadSidebarHeight();

      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å —Ç–æ–ª—å–∫–æ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö
      if (isMobile()) {
        const resizer = document.getElementById('sidebarResizer');
        if (resizer) {
          resizer.style.display = 'flex';
        }
        initSidebarResizer();
      }

      // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ä–∞–∑–º–µ—Ä–∞ –æ–∫–Ω–∞
      window.addEventListener('resize', () => {
        const resizer = document.getElementById('sidebarResizer');
        if (resizer) {
          resizer.style.display = isMobile() ? 'flex' : 'none';
        }
      });

      // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏–∏ (–¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤)
      window.addEventListener('orientationchange', () => {
        setTimeout(() => {
          loadSidebarHeight(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—É—é –≤—ã—Å–æ—Ç—É
          const resizer = document.getElementById('sidebarResizer');
          if (resizer) {
            resizer.style.display = isMobile() ? 'flex' : 'none';
          }
        }, 100);
      });
    });
    
    const ROOM_ID = 'main'; // –û–¥–Ω–∞ –æ–±—â–∞—è –∫–æ–º–Ω–∞—Ç–∞
    
    let originalStream = null;
    let peerConnections = {};
    let audioContext = null;
    let sourceNode = null;
    let destinationNode = null;
    let analyserNode = null;
    let noiseSuppressionEnabled = false;
    let isMuted = false;
    let currentRoom = null;
    let userName = null;
    let remoteAudios = {};
    let remoteStreams = {}; // –•—Ä–∞–Ω–∏–º –ø–æ—Ç–æ–∫–∏ –¥–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏
    let remoteAnalysers = {}; // –ê–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä—ã –¥–ª—è —É–¥–∞–ª–µ–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    let visualizers = {};
    let micVisualizerBars = [];
    let micAnalyser = null;
    let micVisualizerInterval = null;
    let processedAnswers = new Set(); // –û—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ answers

    const nameInput = document.getElementById('nameInput');
    const joinBtn = document.getElementById('joinBtn');
    const leaveBtn = document.getElementById('leaveBtn');
    const status = document.getElementById('status');
    const usersList = document.getElementById('usersList');
    const messages = document.getElementById('messages');
    const messageInput = document.getElementById('messageInput');
    const sendBtn = document.getElementById('sendBtn');
    const micBtn = document.getElementById('micBtn');
    const noiseSuppressionToggle = document.getElementById('noiseSuppressionToggle');
    const micTest = document.getElementById('micTest');
    const micVisualizer = document.getElementById('micVisualizer');
    const micLevel = document.getElementById('micLevel');

    // –°–æ–∑–¥–∞–Ω–∏–µ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ç–æ—Ä–∞ –¥–ª—è –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞
    function createMicVisualizer() {
      micVisualizer.innerHTML = '';
      micVisualizerBars = [];
      for (let i = 0; i < 20; i++) {
        const bar = document.createElement('div');
        bar.className = 'bar';
        bar.style.height = '2px';
        micVisualizer.appendChild(bar);
        micVisualizerBars.push(bar);
      }
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ç–æ—Ä–∞ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞
    function updateMicVisualizer() {
      if (!micAnalyser || !originalStream) return;

      const dataArray = new Uint8Array(micAnalyser.frequencyBinCount);
      micAnalyser.getByteFrequencyData(dataArray);
      
      const average = dataArray.reduce((a, b) => a + b) / dataArray.length;
      const level = Math.round((average / 255) * 100);
      
      micLevel.textContent = `–£—Ä–æ–≤–µ–Ω—å: ${level}%`;
      
      // –û–±–Ω–æ–≤–ª—è–µ–º –±–∞—Ä—ã
      const barCount = micVisualizerBars.length;
      const step = Math.floor(dataArray.length / barCount);
      
      micVisualizerBars.forEach((bar, i) => {
        const index = i * step;
        const value = dataArray[index] || 0;
        const height = Math.max(2, (value / 255) * 60);
        bar.style.height = `${height}px`;
        bar.style.background = height > 40 ? '#ed4245' : height > 20 ? '#faa61a' : '#43b581';
      });
    }

    // –°–æ–∑–¥–∞–Ω–∏–µ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ç–æ—Ä–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    function createUserVisualizer(userId) {
      const visualizer = document.createElement('div');
      visualizer.className = 'user-visualizer';
      visualizer.id = `visualizer-${userId}`;
      
      for (let i = 0; i < 10; i++) {
        const bar = document.createElement('div');
        bar.className = 'user-bar';
        bar.style.height = '1px';
        visualizer.appendChild(bar);
      }
      
      visualizers[userId] = visualizer;
      return visualizer;
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∞–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä–∞ –¥–ª—è —É–¥–∞–ª–µ–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    function initRemoteAnalyser(userId, stream) {
      if (remoteAnalysers[userId]) {
        // –û–±–Ω–æ–≤–ª—è–µ–º –µ—Å–ª–∏ –ø–æ—Ç–æ–∫ –∏–∑–º–µ–Ω–∏–ª—Å—è
        if (remoteStreams[userId] !== stream) {
          try {
            if (remoteAnalysers[userId].audioContext) {
              remoteAnalysers[userId].audioContext.close();
            }
          } catch (e) {}
          delete remoteAnalysers[userId];
        } else {
          return; // –£–∂–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω
        }
      }
      
      try {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const source = ctx.createMediaStreamSource(stream);
        const analyser = ctx.createAnalyser();
        analyser.fftSize = 256;
        analyser.smoothingTimeConstant = 0.8;
        source.connect(analyser);
        
        // –ù–ï –ø–æ–¥–∫–ª—é—á–∞–µ–º –∫ destination - –∑–≤—É–∫ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—Å—è —á–µ—Ä–µ–∑ Audio —ç–ª–µ–º–µ–Ω—Ç
        // –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ destination –º–æ–∂–µ—Ç –≤—ã–∑–≤–∞—Ç—å –ø—Ä–æ–±–ª–µ–º—ã —Å –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ–º
        
        analyser.audioContext = ctx; // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è
        remoteAnalysers[userId] = analyser;
        remoteStreams[userId] = stream;
        
        console.log(`‚úÖ Analyser initialized for ${userId}`);
      } catch (e) {
        console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –∞–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä –¥–ª—è', userId, e);
      }
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ç–æ—Ä–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    function updateUserVisualizer(userId) {
      if (!visualizers[userId]) return;
      
      const analyser = remoteAnalysers[userId];
      if (!analyser) return;

      const dataArray = new Uint8Array(analyser.frequencyBinCount);
      analyser.getByteFrequencyData(dataArray);
      
      const bars = visualizers[userId].querySelectorAll('.user-bar');
      const barCount = bars.length;
      const step = Math.floor(dataArray.length / barCount);
      
      bars.forEach((bar, i) => {
        const index = i * step;
        const value = dataArray[index] || 0;
        const height = Math.max(1, (value / 255) * 20);
        bar.style.height = `${height}px`;
        bar.style.background = height > 15 ? '#43b581' : height > 8 ? '#faa61a' : '#72767d';
      });
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Web Audio API –¥–ª—è —à—É–º–æ–ø–æ–¥–∞–≤–ª–µ–Ω–∏—è
    function initAudioContext(stream) {
      // –ó–∞–∫—Ä—ã–≤–∞–µ–º —Å—Ç–∞—Ä—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –µ—Å–ª–∏ –µ—Å—Ç—å
      if (audioContext && audioContext.state !== 'closed') {
        try {
          if (destinationNode) {
            destinationNode.disconnect();
          }
          if (sourceNode) {
            sourceNode.disconnect();
          }
          audioContext.close();
        } catch (e) {
          console.warn('Error closing old audio context:', e);
        }
      }
      
      audioContext = new (window.AudioContext || window.webkitAudioContext)();
      sourceNode = audioContext.createMediaStreamSource(stream);
      
      // –°–æ–∑–¥–∞—ë–º –∞–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä –¥–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞
      micAnalyser = audioContext.createAnalyser();
      micAnalyser.fftSize = 256;
      micAnalyser.smoothingTimeConstant = 0.8;
      sourceNode.connect(micAnalyser);
      
      // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–æ—Å—Ç–æ–µ –∏ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–µ —à—É–º–æ–ø–æ–¥–∞–≤–ª–µ–Ω–∏–µ
      // –û—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞: –ø–æ–ª–∞–≥–∞–µ–º—Å—è –Ω–∞ –≤—Å—Ç—Ä–æ–µ–Ω–Ω–æ–µ —à—É–º–æ–ø–æ–¥–∞–≤–ª–µ–Ω–∏–µ –±—Ä–∞—É–∑–µ—Ä–∞ + –ª–µ–≥–∫–∞—è –ø–æ—Å—Ç–æ–±—Ä–∞–±–æ—Ç–∫–∞
      //
      // –î–ª—è –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–≥–æ —à—É–º–æ–ø–æ–¥–∞–≤–ª–µ–Ω–∏—è —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è Krisp.ai:
      // 1. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ Krisp –¥–ª—è –±—Ä–∞—É–∑–µ—Ä–∞
      // 2. –í–∫–ª—é—á–∏—Ç–µ –µ–≥–æ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞
      // 3. –û–Ω–æ –æ–±–µ—Å–ø–µ—á–∏—Ç AI-based –ø–æ–¥–∞–≤–ª–µ–Ω–∏–µ —à—É–º–æ–≤ –ª—É—á—à–µ –ª—é–±–æ–π –≤–µ–±-—Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏

      // –õ–µ–≥–∫–∏–π high-pass —Ñ–∏–ª—å—Ç—Ä –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –æ—á–µ–Ω—å –Ω–∏–∑–∫–∏—Ö —á–∞—Å—Ç–æ—Ç (–≥—É–ª, –∏–Ω—Ñ—Ä–∞–∑–≤—É–∫)
      const highPass = audioContext.createBiquadFilter();
      highPass.type = 'highpass';
      highPass.frequency.value = 80; // –õ–µ–≥–∫–∏–π —Ñ–∏–ª—å—Ç—Ä, –Ω–µ —Ä–µ–∂–µ—Ç –≥–æ–ª–æ—Å
      highPass.Q.value = 0.5; // –ú—è–≥–∫–∏–π —Å—Ä–µ–∑

      // –û—á–µ–Ω—å –ª—ë–≥–∫–∏–π –∫–æ–º–ø—Ä–µ—Å—Å–æ—Ä –¥–ª—è –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏—è –≥—Ä–æ–º–∫–æ—Å—Ç–∏
      const compressor = audioContext.createDynamicsCompressor();
      compressor.threshold.value = -20; // –í—ã—Å–æ–∫–∏–π –ø–æ—Ä–æ–≥, —Ç–æ–ª—å–∫–æ –¥–ª—è –ø–∏–∫–æ–≤
      compressor.knee.value = 20; // –ú—è–≥–∫–æ–µ –∫–æ–ª–µ–Ω–æ
      compressor.ratio.value = 3; // –õ–µ–≥–∫–æ–µ —Å–∂–∞—Ç–∏–µ
      compressor.attack.value = 0.01; // –ü–ª–∞–≤–Ω–∞—è –∞—Ç–∞–∫–∞
      compressor.release.value = 0.2; // –ü–ª–∞–≤–Ω–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ

      // –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è —É—Ä–æ–≤–Ω—è (–±–µ–∑ —É—Å–∏–ª–µ–Ω–∏—è)
      const gainNode = audioContext.createGain();
      gainNode.gain.value = 1.0; // –ë–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π —É—Ä–æ–≤–Ω—è

      // –ü—Ä–æ—Å—Ç–∞—è —Ü–µ–ø–æ—á–∫–∞: source -> highPass -> compressor -> gain -> destination
      sourceNode.connect(highPass);
      highPass.connect(compressor);
      compressor.connect(gainNode);
      
      // –°–æ–∑–¥–∞—ë–º destination –¥–ª—è WebRTC
      destinationNode = audioContext.createMediaStreamDestination();
      gainNode.connect(destinationNode);

      console.log('‚úÖ Audio context initialized with browser noise suppression + light processing');
      return destinationNode.stream;
    }

    function getStreamForWebRTC() {
      // –ï—Å–ª–∏ —à—É–º–æ–ø–æ–¥–∞–≤–ª–µ–Ω–∏–µ –≤–∫–ª—é—á–µ–Ω–æ –∏ destination –≥–æ—Ç–æ–≤, –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ
      if (noiseSuppressionEnabled && destinationNode && audioContext && audioContext.state === 'running') {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –≤ destination –µ—Å—Ç—å —Ç—Ä–µ–∫–∏
        if (destinationNode.stream.getAudioTracks().length > 0) {
          return destinationNode.stream;
        }
      }
      // –ò–Ω–∞—á–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –ø–æ—Ç–æ–∫
      return originalStream;
    }

    async function createPeerConnection(userId) {
      // –ó–∞–∫—Ä—ã–≤–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –µ—Å–ª–∏ –µ—Å—Ç—å
      if (peerConnections[userId]) {
        peerConnections[userId].close();
      }

      const pc = new RTCPeerConnection({
        iceServers: [
          // STUN —Å–µ—Ä–≤–µ—Ä—ã –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø—É–±–ª–∏—á–Ω–æ–≥–æ IP
          { urls: 'stun:stun.l.google.com:19302' },
          { urls: 'stun:stun1.l.google.com:19302' },
          { urls: 'stun:stun2.l.google.com:19302' },
          { urls: 'stun:stun3.l.google.com:19302' },
          { urls: 'stun:stun4.l.google.com:19302' },
          // –ü—É–±–ª–∏—á–Ω—ã–µ TURN —Å–µ—Ä–≤–µ—Ä—ã (—Ä–∞–∑–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã)
          {
            urls: [
              'turn:turn.bistri.com:80',
              'turn:turn.bistri.com:443',
              'turn:turn.bistri.com:80?transport=tcp'
            ],
            username: 'webrtc',
            credential: 'webrtc'
          },
          {
            urls: [
              'turn:numb.viagenie.ca',
              'turn:numb.viagenie.ca:3478'
            ],
            username: 'webrtc@live.com',
            credential: 'muazkh'
          },
          {
            urls: [
              'turn:turn.anyfirewall.com:443',
              'turn:turn.anyfirewall.com:80'
            ],
            username: 'webrtc',
            credential: 'webrtc'
          },
          // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø—É–±–ª–∏—á–Ω—ã–µ TURN —Å–µ—Ä–≤–µ—Ä—ã
          {
            urls: 'turn:openrelay.metered.ca:80',
            username: 'openrelayproject',
            credential: 'openrelayproject'
          },
          {
            urls: 'turn:relay.metered.ca:80',
            username: 'c2d4e8f5b5c3d4e8f5b5c3',
            credential: 'c2d4e8f5b5c3d4e8f5b5c3'
          }
        ],
        iceCandidatePoolSize: 0
      });

      // –î–æ–±–∞–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π –ø–æ—Ç–æ–∫
      const streamToAdd = getStreamForWebRTC();
      if (streamToAdd && streamToAdd.getAudioTracks().length > 0) {
        streamToAdd.getAudioTracks().forEach(track => {
          if (track.readyState === 'live') {
            console.log(`Adding local track to ${userId}:`, track.id, track.enabled, track.kind);
            pc.addTrack(track, streamToAdd);
          } else {
            console.warn(`Track not ready for ${userId}:`, track.readyState);
          }
        });
      } else {
        console.error(`No stream or tracks available for ${userId}`);
      }
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ç—Ä–µ–∫–∏ –¥–æ–±–∞–≤–ª–µ–Ω—ã
      pc.getSenders().forEach(sender => {
        if (sender.track) {
          console.log(`Sender track for ${userId}:`, sender.track.kind, sender.track.enabled);
        }
      });

      // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Ö–æ–¥—è—â–∏—Ö —Ç—Ä–µ–∫–æ–≤
      pc.ontrack = (event) => {
        console.log('Received track from', userId, event);
        console.log('Track kind:', event.track.kind, 'Track id:', event.track.id);
        const [remoteStream] = event.streams;
        if (remoteStream && remoteStream.getAudioTracks().length > 0) {
          console.log(`Audio track received from ${userId}, enabled:`, remoteStream.getAudioTracks()[0].enabled);
          if (!remoteAudios[userId]) {
            const audio = new Audio();
            audio.srcObject = remoteStream;
            audio.autoplay = true;
            audio.volume = 1.0;
            audio.setAttribute('playsinline', 'true'); // –î–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
            audio.onloadedmetadata = () => {
              console.log(`Audio metadata loaded for ${userId}`);
            };
            
            audio.onplay = () => {
              console.log(`Audio started playing for ${userId}`);
            };
            
            audio.onerror = (e) => {
              console.error(`Audio error for ${userId}:`, e);
            };
            
            remoteAudios[userId] = audio;
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∞–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä –¥–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ –î–û –ø–æ–ø—ã—Ç–∫–∏ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è
            initRemoteAnalyser(userId, remoteStream);
            
            // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ç–æ—Ä —Å–æ–∑–¥–∞–Ω
            const userItemEl = document.getElementById(`user-${userId}`);
            if (userItemEl) {
              const userInfo = userItemEl.querySelector('.user-info');
              if (userInfo && !userInfo.querySelector('.user-visualizer')) {
                const visualizer = createUserVisualizer(userId);
                userInfo.appendChild(visualizer);
              }
            }
            
            // –ú–æ—â–Ω–∞—è –ª–æ–≥–∏–∫–∞ –∑–∞–ø—É—Å–∫–∞ –∞—É–¥–∏–æ
            const playAudio = async (attempt = 1) => {
              try {
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≥—Ä–æ–º–∫–æ—Å—Ç—å –∏ –¥—Ä—É–≥–∏–µ —Å–≤–æ–π—Å—Ç–≤–∞
                audio.volume = 1.0;
                audio.muted = false;

                await audio.play();
                console.log(`‚úÖ Audio playing successfully for ${userId} on attempt ${attempt}`);

                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
                const statusEl = document.getElementById(`status-${userId}`);
                if (statusEl) {
                  statusEl.textContent = 'üéµ –°–ª—ã—à–Ω–æ';
                  statusEl.style.color = '#43b581';
                }

              } catch (err) {
                console.warn(`‚ö†Ô∏è Autoplay blocked for ${userId} on attempt ${attempt}:`, err.name);

                // –ü–æ–≤—Ç–æ—Ä—è–µ–º –ø–æ–ø—ã—Ç–∫–∏ —Å —É–≤–µ–ª–∏—á–∏–≤–∞—é—â–µ–π—Å—è –∑–∞–¥–µ—Ä–∂–∫–æ–π
                if (attempt < 5) {
                  setTimeout(() => playAudio(attempt + 1), attempt * 1000);
                } else {
                  console.error(`‚ùå Failed to play audio for ${userId} after ${attempt} attempts`);

                  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É –≤ —Å—Ç–∞—Ç—É—Å–µ
                  const statusEl = document.getElementById(`status-${userId}`);
                  if (statusEl) {
                    statusEl.textContent = 'üîá –ê–≤—Ç–æ–ø–ª–µ–π –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω';
                    statusEl.style.color = '#ed4245';
                  }
                }
              }
            };

            // –ü—Ä–æ–±—É–µ–º —Å—Ä–∞–∑—É
            playAudio();

            // –¢–∞–∫–∂–µ –ø—Ä–æ–±—É–µ–º –ø—Ä–∏ –ª—é–±–æ–º –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            const enableAudioOnInteraction = () => {
              if (audio.paused || audio.readyState === 0) {
                debugLog(`User interaction detected, trying to play audio for ${userId}`);
                playAudio();
              }
            };

            // –î–æ–±–∞–≤–ª—è–µ–º –Ω–µ—Å–∫–æ–ª—å–∫–æ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è
            const events = ['click', 'touchstart', 'keydown', 'mousedown'];
            events.forEach(event => {
              document.addEventListener(event, enableAudioOnInteraction, { once: false });
            });

            // –¢–∞–∫–∂–µ –ø—Ä–æ–±—É–µ–º –∑–∞–ø—É—Å—Ç–∏—Ç—å —á–µ—Ä–µ–∑ –Ω–µ–∫–æ—Ç–æ—Ä–æ–µ –≤—Ä–µ–º—è
            setTimeout(() => {
              if (audio.paused) {
                console.log(`‚è∞ Trying to play audio for ${userId} after delay`);
                playAudio();
              }
            }, 2000);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å - —Ç—Ä–µ–∫ –ø–æ–ª—É—á–µ–Ω
            const statusEl = document.getElementById(`status-${userId}`);
            if (statusEl) {
              statusEl.textContent = '‚úÖ –ê—É–¥–∏–æ –ø–æ–ª—É—á–µ–Ω–æ';
              statusEl.style.color = '#43b581';
            }
          } else {
            remoteAudios[userId].srcObject = remoteStream;
            // –û–±–Ω–æ–≤–ª—è–µ–º –∞–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä –µ—Å–ª–∏ –ø–æ—Ç–æ–∫ –∏–∑–º–µ–Ω–∏–ª—Å—è
            if (remoteStream !== remoteStreams[userId]) {
              initRemoteAnalyser(userId, remoteStream);
            }
          }
        }
      };

      // –û—Ç–ø—Ä–∞–≤–∫–∞ ICE –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤
      let candidateCount = 0;
      let hasRelayCandidate = false;
      let hasSrflxCandidate = false;
      let hasHostCandidate = false;

      pc.onicecandidate = (event) => {
        if (event.candidate) {
          candidateCount++;
          const candidateType = event.candidate.type;
          const candidateProtocol = event.candidate.protocol;

          switch (candidateType) {
            case 'relay':
              hasRelayCandidate = true;
              console.log(`üéØ TURN relay candidate #${candidateCount} from ${userId} (${candidateProtocol})`);
              break;
            case 'srflx':
              hasSrflxCandidate = true;
              console.log(`üì° STUN srflx candidate #${candidateCount} from ${userId} (${candidateProtocol})`);
              break;
            case 'host':
              hasHostCandidate = true;
              console.log(`üè† Host candidate #${candidateCount} from ${userId} (${candidateProtocol})`);
              break;
            default:
              console.log(`‚ùì Unknown candidate type ${candidateType} #${candidateCount} from ${userId}`);
          }

          // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –Ω–µ –∑–∞–∫—Ä—ã—Ç–æ
          if (pc.signalingState !== 'closed') {
            socket.emit('ice-candidate', {
              candidate: event.candidate,
              to: userId,
              roomId: currentRoom
            });
          }
        } else {
          console.log(`‚úÖ All ICE candidates gathered for ${userId}:`);
          console.log(`   - Host: ${hasHostCandidate}`);
          console.log(`   - Srflx: ${hasSrflxCandidate}`);
          console.log(`   - Relay: ${hasRelayCandidate}`);
          console.log(`   - Total: ${candidateCount}`);
          console.log(`   - Signaling state: ${pc.signalingState}, ICE state: ${pc.iceConnectionState}`);

          if (!hasRelayCandidate && !hasSrflxCandidate) {
            console.log(`‚ÑπÔ∏è Only host candidates available for ${userId} - will work locally on same network`);
            // –î–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å—Ä–∞–∑—É —Å—á–∏—Ç–∞–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω—ã–º
            console.log(`‚úÖ Local connection established for ${userId} (host candidates only)`);
            const statusEl = document.getElementById(`status-${userId}`);
            if (statusEl) {
              statusEl.textContent = '‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ';
              statusEl.style.color = '#43b581';
            }

            // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
            setTimeout(() => {
              if (pc.iceConnectionState === 'checking' && pc.signalingState === 'stable') {
                console.log(`üéâ Forcing connection state for local testing with ${userId}`);
                // –í –ª–æ–∫–∞–ª—å–Ω–æ–º —Ä–µ–∂–∏–º–µ –º—ã –º–æ–∂–µ–º —Å—á–∏—Ç–∞—Ç—å, —á—Ç–æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
                // –¥–∞–∂–µ –µ—Å–ª–∏ ICE –≤—Å–µ –µ—â–µ checking
              }
            }, 1000);
          } else if (hasRelayCandidate) {
            console.log(`‚úÖ TURN relay available for ${userId} - good connectivity`);
          } else {
            console.log(`‚ö†Ô∏è No TURN relay for ${userId} - STUN srflx available`);
          }
        }
      };

      pc.oniceconnectionstatechange = () => {
        const state = pc.iceConnectionState;
        console.log(`ICE connection state with ${userId}:`, state, 'Signaling:', pc.signalingState);
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –≤ UI
        const statusEl = document.getElementById(`status-${userId}`);
        if (statusEl) {
          const statusText = {
            'new': 'üîÑ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...',
            'checking': 'üîÑ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è...',
            'connected': '‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ',
            'completed': '‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ',
            'failed': '‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è',
            'disconnected': '‚ö†Ô∏è –û—Ç–∫–ª—é—á–µ–Ω–æ',
            'closed': '‚ùå –ó–∞–∫—Ä—ã—Ç–æ'
          }[state] || '–û–∂–∏–¥–∞–Ω–∏–µ...';
          
          statusEl.textContent = statusText;
          statusEl.style.color = state === 'connected' || state === 'completed' ? '#43b581' : 
                                 state === 'failed' || state === 'closed' ? '#ed4245' : '#8e9297';
        }
        
        // –ï—Å–ª–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ
        if (state === 'connected' || state === 'completed') {
          console.log(`‚úÖ Successfully connected to ${userId}, ICE: ${state}`);
          // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –µ—â–µ —Ä–∞–∑ –¥–ª—è —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏
          const statusEl = document.getElementById(`status-${userId}`);
          if (statusEl) {
            statusEl.textContent = '‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ';
            statusEl.style.color = '#43b581';
          }
        }

        // –î–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è: –µ—Å–ª–∏ –¥–æ–ª–≥–æ checking –∏ –µ—Å—Ç—å host –∫–∞–Ω–¥–∏–¥–∞—Ç—ã
        if (state === 'checking') {
          // –ü—Ä–æ–≤–µ—Ä–∏–º —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã, –µ—Å–ª–∏ –≤—Å–µ –µ—â–µ checking
          setTimeout(() => {
            if (peerConnections[userId] &&
                peerConnections[userId].iceConnectionState === 'checking' &&
                peerConnections[userId].signalingState === 'stable') {
              console.log(`üîÑ Still checking ICE for ${userId}, but signaling is stable - likely local connection`);
              // –í –ª–æ–∫–∞–ª—å–Ω–æ–º —Ä–µ–∂–∏–º–µ –º–æ–∂–µ–º —Å—á–∏—Ç–∞—Ç—å —É—Å–ø–µ—à–Ω—ã–º
              const statusEl = document.getElementById(`status-${userId}`);
              if (statusEl && statusEl.textContent.includes('–ü—Ä–æ–≤–µ—Ä–∫–∞')) {
                console.log(`‚úÖ Assuming local connection successful for ${userId}`);
                statusEl.textContent = '‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ';
                statusEl.style.color = '#43b581';
              }
            }
          }, 3000);
        }
        
        // –ï—Å–ª–∏ disconnected, –ø—ã—Ç–∞–µ–º—Å—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å
        if (state === 'disconnected') {
          console.warn(`ICE disconnected with ${userId}, will attempt reconnect if stays disconnected`);
          setTimeout(() => {
            if (peerConnections[userId] && peerConnections[userId].iceConnectionState === 'disconnected') {
              console.log(`Reconnecting to ${userId} after disconnect...`);
              establishConnection(userId);
            }
          }, 3000);
        }
        
        // –ï—Å–ª–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –Ω–µ —É–¥–∞–ª–æ—Å—å, –ø—ã—Ç–∞–µ–º—Å—è –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è
        if (state === 'failed') {
          console.warn(`ICE connection failed with ${userId}, attempting to reconnect...`);
          setTimeout(() => {
            if (peerConnections[userId] && peerConnections[userId].iceConnectionState === 'failed') {
              console.log(`Attempting to reconnect to ${userId}...`);
              establishConnection(userId);
            }
          }, 2000);
        }
      };

      pc.onconnectionstatechange = () => {
        const state = pc.connectionState;
        const iceState = pc.iceConnectionState;
        console.log(`Connection state with ${userId}:`, state, 'ICE:', iceState);
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –≤ UI
        const statusEl = document.getElementById(`status-${userId}`);
        if (statusEl) {
          if (state === 'connected' && (iceState === 'connected' || iceState === 'completed')) {
            statusEl.textContent = '‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ';
            statusEl.style.color = '#43b581';
          } else if (state === 'connecting' || iceState === 'checking') {
            statusEl.textContent = 'üîÑ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è...';
            statusEl.style.color = '#8e9297';
          } else if (state === 'failed' || iceState === 'failed') {
            statusEl.textContent = '‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è';
            statusEl.style.color = '#ed4245';
          }
        }
        
        if (state === 'failed' || state === 'disconnected') {
          if (remoteAudios[userId]) {
            remoteAudios[userId].pause();
            delete remoteAudios[userId];
          }
        }
        
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–∏ –æ—à–∏–±–∫–µ
        if (state === 'failed') {
          console.error(`‚ùå WebRTC connection failed with ${userId}, attempting to reconnect...`);
          setTimeout(() => {
            if (peerConnections[userId] && peerConnections[userId].connectionState === 'failed') {
              console.log(`üîÑ Restarting WebRTC connection to ${userId}...`);
              establishConnection(userId);
            }
          }, 3000);
        }
        
        // –õ–æ–≥–∏—Ä—É–µ–º —É—Å–ø–µ—à–Ω–æ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
        if (state === 'connected' && (iceState === 'connected' || iceState === 'completed')) {
          console.log(`‚úÖ‚úÖ‚úÖ FULLY CONNECTED to ${userId} - audio should work now!`);
        }
      };
      
      // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ ICE –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
      pc.onicecandidateerror = (event) => {
        // –õ–æ–≥–∏—Ä—É–µ–º –≤—Å–µ –æ—à–∏–±–∫–∏ ICE, –Ω–æ –Ω–µ –≤—Å–µ —Å–µ—Ä—å–µ–∑–Ω—ã–µ
        console.warn(`ICE candidate error with ${userId}: code=${event.errorCode}, url=${event.url}`);
      };

      // –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ gathering state
      pc.onicegatheringstatechange = () => {
        console.log(`ICE gathering state with ${userId}:`, pc.iceGatheringState);
      };

      return pc;
    }

    async function establishConnection(userId) {
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
      if (peerConnections[userId]) {
        const existingState = peerConnections[userId].signalingState;
        const existingConnState = peerConnections[userId].connectionState;
        const existingIceState = peerConnections[userId].iceConnectionState;
        
        // –ï—Å–ª–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç, –Ω–µ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∞–µ–º—Å—è
        if (existingState !== 'closed' && 
            existingConnState !== 'closed' && existingConnState !== 'failed' &&
            (existingIceState === 'connected' || existingIceState === 'completed' || existingIceState === 'checking')) {
          console.log(`Connection with ${userId} already exists and active, state:`, existingState, existingConnState, existingIceState);
          return;
        } else {
          console.log(`Closing old connection with ${userId}, state:`, existingState, existingConnState, existingIceState);
          try {
            peerConnections[userId].close();
          } catch (e) {
            console.warn('Error closing old connection:', e);
          }
          delete peerConnections[userId];
        }
      }

      if (!originalStream) {
        console.error('No local stream available');
        return;
      }

      const pc = await createPeerConnection(userId);
      peerConnections[userId] = pc;

      try {
        // –°–æ–∑–¥–∞—ë–º offer —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏
        debugLog(`Creating offer for ${userId}...`);
        const offer = await pc.createOffer({
          offerToReceiveAudio: true,
          offerToReceiveVideo: false
        });

        debugLog(`Setting local description for ${userId}...`);
        await pc.setLocalDescription(offer);

        debugLog(`‚úÖ Offer created and set for ${userId}:`, offer.type, `Signaling state: ${pc.signalingState}`);

        socket.emit('offer', {
          offer: pc.localDescription,
          to: userId,
          roomId: currentRoom
        });
      } catch (err) {
        console.error('‚ùå Error creating offer for', userId, ':', err);
        status.textContent = `–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å ${userId}`;
        status.className = 'status error';
      }
    }

    joinBtn.addEventListener('click', async () => {
      const name = nameInput.value.trim() || `User-${Math.random().toString(36).substr(2, 6)}`;

      // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
      saveUsername(name);

      debugLog('üöÄ Joining room with name:', name);

      try {
        // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É
        const stream = await navigator.mediaDevices.getUserMedia({ 
          audio: {
            echoCancellation: true,
            noiseSuppression: true,
            autoGainControl: true,
            sampleRate: 48000
          }
        });

        originalStream = stream;
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∞—É–¥–∏–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞
        // –°–æ–∑–¥–∞–µ–º –æ—Ç–¥–µ–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏, —á—Ç–æ–±—ã –Ω–µ –º–µ—à–∞—Ç—å WebRTC
        const vizContext = new (window.AudioContext || window.webkitAudioContext)();
        const vizSource = vizContext.createMediaStreamSource(originalStream);
        micAnalyser = vizContext.createAnalyser();
        micAnalyser.fftSize = 256;
        micAnalyser.smoothingTimeConstant = 0.8;
        vizSource.connect(micAnalyser);
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∞—É–¥–∏–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç –µ—Å–ª–∏ —à—É–º–æ–ø–æ–¥–∞–≤–ª–µ–Ω–∏–µ –≤–∫–ª—é—á–µ–Ω–æ
        if (noiseSuppressionEnabled) {
          initAudioContext(originalStream);
        }

        currentRoom = ROOM_ID;
        userName = name;

        socket.emit('join-room', { roomId: ROOM_ID, name });
        
        // –°–æ–∑–¥–∞–µ–º –≤–∏–∑—É–∞–ª–∏–∑–∞—Ç–æ—Ä –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞
        createMicVisualizer();
        micTest.style.display = 'block';
        micVisualizerInterval = setInterval(updateMicVisualizer, 100);
        
        joinBtn.disabled = true;
        leaveBtn.disabled = false;
        micBtn.disabled = false;
        messageInput.disabled = false;
        sendBtn.disabled = false;
        nameInput.disabled = true;
        
        status.textContent = '–ü–æ–¥–∫–ª—é—á–µ–Ω–æ';
        status.className = 'status connected';
      } catch (err) {
        console.error('–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É:', err);
        alert('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –±—Ä–∞—É–∑–µ—Ä–∞.');
      }
    });

    leaveBtn.addEventListener('click', () => {
      // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
      Object.values(peerConnections).forEach(pc => pc.close());
      peerConnections = {};
      
      Object.values(remoteAudios).forEach(audio => {
        audio.pause();
        audio.srcObject = null;
      });
      remoteAudios = {};
      remoteAnalysers = {};
      remoteStreams = {};

      if (originalStream) {
        originalStream.getTracks().forEach(track => track.stop());
        originalStream = null;
      }

      if (audioContext && audioContext.state !== 'closed') {
        audioContext.close();
        audioContext = null;
      }

      if (micVisualizerInterval) {
        clearInterval(micVisualizerInterval);
        micVisualizerInterval = null;
      }

      processedAnswers.clear(); // –û—á–∏—â–∞–µ–º –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ answers

      socket.emit('leave-room', { roomId: currentRoom });
      
      currentRoom = null;
      userName = null;
      visualizers = {};
      
      joinBtn.disabled = false;
      leaveBtn.disabled = true;
      micBtn.disabled = true;
      messageInput.disabled = true;
      sendBtn.disabled = true;
      nameInput.disabled = false;
      
      status.textContent = '–ù–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ';
      status.className = 'status';
      usersList.innerHTML = '';
      messages.innerHTML = '';
      micTest.style.display = 'none';
    });

    micBtn.addEventListener('click', () => {
      if (!originalStream) return;

      isMuted = !isMuted;
      originalStream.getAudioTracks().forEach(track => {
        track.enabled = !isMuted;
      });

      micBtn.textContent = isMuted ? 'üîá –ú–∏–∫—Ä–æ—Ñ–æ–Ω –≤—ã–∫–ª—é—á–µ–Ω' : 'üé§ –ú–∏–∫—Ä–æ—Ñ–æ–Ω';
      micBtn.classList.toggle('muted', isMuted);
    });


    noiseSuppressionToggle.addEventListener('click', () => {
      if (!originalStream) return;

      noiseSuppressionEnabled = !noiseSuppressionEnabled;
      noiseSuppressionToggle.classList.toggle('active', noiseSuppressionEnabled);

      if (noiseSuppressionEnabled) {
        initAudioContext(originalStream);

        // –û–±–Ω–æ–≤–ª—è–µ–º —Ç—Ä–µ–∫–∏ –≤–æ –≤—Å–µ—Ö peer connections
        const streamToUse = getStreamForWebRTC();
        if (streamToUse) {
          Object.entries(peerConnections).forEach(([userId, pc]) => {
            const sender = pc.getSenders().find(s => s.track && s.track.kind === 'audio');
            if (sender && streamToUse.getAudioTracks()[0]) {
              sender.replaceTrack(streamToUse.getAudioTracks()[0]);
            }
          });
        }
      } else {
        if (audioContext && destinationNode) {
          // –ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –ø–æ—Ç–æ–∫
          Object.entries(peerConnections).forEach(([userId, pc]) => {
            const sender = pc.getSenders().find(s => s.track && s.track.kind === 'audio');
            if (sender && originalStream.getAudioTracks()[0]) {
              sender.replaceTrack(originalStream.getAudioTracks()[0]);
            }
          });
        }
      }
    });


    sendBtn.addEventListener('click', () => {
      const message = messageInput.value.trim();
      if (message && currentRoom) {
        socket.emit('message', { roomId: currentRoom, message });
        messageInput.value = '';
      }
    });

    messageInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        sendBtn.click();
      }
    });

    // Socket events
    socket.on('room-full', () => {
      alert('–ö–æ–º–Ω–∞—Ç–∞ –∑–∞–ø–æ–ª–Ω–µ–Ω–∞ (–º–∞–∫—Å–∏–º—É–º 4 —á–µ–ª–æ–≤–µ–∫–∞)');
      status.textContent = '–ö–æ–º–Ω–∞—Ç–∞ –∑–∞–ø–æ–ª–Ω–µ–Ω–∞';
      status.className = 'status error';
    });

    socket.on('room-users', (users) => {
      usersList.innerHTML = '';
      users.forEach(user => {
        const userItem = document.createElement('div');
        userItem.className = 'user-item';
        userItem.id = `user-${user.id}`;

        // –î–ª—è —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –∏–º—è –∏ –∞–≤–∞—Ç–∞—Ä–∫—É
        if (user.id === currentUserId) {
          debugLog('Showing current user without status/visualizer:', user.id);
          userItem.innerHTML = `
            <div class="user-avatar">${user.name[0].toUpperCase()}</div>
            <div class="user-info">
              <div class="user-name">${user.name} (–í—ã)</div>
            </div>
          `;
        } else {
          // –î–ª—è –¥—Ä—É–≥–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–ª–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
          // –°–æ–∑–¥–∞–µ–º –≤–∏–∑—É–∞–ª–∏–∑–∞—Ç–æ—Ä —Å—Ä–∞–∑—É
          const visualizer = createUserVisualizer(user.id);

          userItem.innerHTML = `
            <div class="user-avatar">${user.name[0].toUpperCase()}</div>
            <div class="user-info">
              <div class="user-name">${user.name}</div>
              <div class="user-status" id="status-${user.id}">–û–∂–∏–¥–∞–Ω–∏–µ...</div>
            </div>
          `;

          // –î–æ–±–∞–≤–ª—è–µ–º –≤–∏–∑—É–∞–ª–∏–∑–∞—Ç–æ—Ä
          const userInfo = userItem.querySelector('.user-info');
          if (userInfo) {
            userInfo.appendChild(visualizer);
          }
        }

        usersList.appendChild(userItem);
      });
    });

    socket.on('user-joined', ({ userId, name }) => {
      debugLog('üëã User joined:', userId, name);

      const userItem = document.createElement('div');
      userItem.className = 'user-item';
      userItem.id = `user-${userId}`;

      // –î–ª—è —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –∏–º—è –∏ –∞–≤–∞—Ç–∞—Ä–∫—É
      if (userId === currentUserId) {
        debugLog('Showing current user in joined event:', userId);
        userItem.innerHTML = `
          <div class="user-avatar">${name[0].toUpperCase()}</div>
          <div class="user-info">
            <div class="user-name">${name} (–í—ã)</div>
          </div>
        `;
      } else {
        // –î–ª—è –¥—Ä—É–≥–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–ª–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
        // –°–æ–∑–¥–∞–µ–º –≤–∏–∑—É–∞–ª–∏–∑–∞—Ç–æ—Ä —Å—Ä–∞–∑—É
        const visualizer = createUserVisualizer(userId);

        userItem.innerHTML = `
          <div class="user-avatar">${name[0].toUpperCase()}</div>
          <div class="user-info">
            <div class="user-name">${name}</div>
            <div class="user-status" id="status-${userId}">–û–∂–∏–¥–∞–Ω–∏–µ...</div>
          </div>
        `;

        // –î–æ–±–∞–≤–ª—è–µ–º –≤–∏–∑—É–∞–ª–∏–∑–∞—Ç–æ—Ä
        const userInfo = userItem.querySelector('.user-info');
        if (userInfo) {
          userInfo.appendChild(visualizer);
        }
      }

      usersList.appendChild(userItem);

      // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å –Ω–æ–≤—ã–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —ç—Ç–æ –Ω–µ —Ç–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å)
      if (userId !== currentUserId && originalStream) {
        debugLog('üîó Establishing connection to new user:', userId);
        establishConnection(userId);
      } else if (userId === currentUserId) {
        debugLog('‚ÑπÔ∏è Skipping connection establishment for current user');
      } else {
        debugLog('‚ö†Ô∏è Cannot establish connection - no local stream');
      }
    });

    socket.on('user-left', ({ userId }) => {
      const userItem = document.getElementById(`user-${userId}`);
      if (userItem) {
        userItem.remove();
      }
      
      if (peerConnections[userId]) {
        peerConnections[userId].close();
        delete peerConnections[userId];
      }
      
      if (remoteAudios[userId]) {
        remoteAudios[userId].pause();
        delete remoteAudios[userId];
      }
      
      if (remoteAnalysers[userId]) {
        delete remoteAnalysers[userId];
      }
      
      if (remoteStreams[userId]) {
        delete remoteStreams[userId];
      }
      
      if (visualizers[userId]) {
        delete visualizers[userId];
      }
    });

    socket.on('existing-user', ({ userId, name }) => {
      if (originalStream) {
        establishConnection(userId);
      }
    });

    socket.on('offer', async ({ offer, from }) => {
      if (!originalStream) {
        console.error('No local stream to answer offer');
        return;
      }

      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ—Ç –ª–∏ —É–∂–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
      if (peerConnections[from]) {
        const existingState = peerConnections[from].signalingState;
        if (existingState !== 'closed' && existingState !== 'have-remote-offer') {
          console.log(`Already have connection with ${from}, state: ${existingState}, closing old one`);
          peerConnections[from].close();
          delete peerConnections[from];
        }
      }

      const pc = await createPeerConnection(from);
      peerConnections[from] = pc;
      
      try {
        console.log(`üì® Received offer from ${from}, setting remote description...`);
        await pc.setRemoteDescription(new RTCSessionDescription(offer));
        console.log(`‚úÖ Remote offer set for ${from}, creating answer...`);

        const answer = await pc.createAnswer({
          offerToReceiveAudio: true,
          offerToReceiveVideo: false
        });

        console.log(`Setting local description for ${from}...`);
    await pc.setLocalDescription(answer);

        console.log(`‚úÖ Answer created and set for ${from}:`, answer.type, `State: ${pc.signalingState}`);

        socket.emit('answer', {
          answer: pc.localDescription,
          to: from,
          roomId: currentRoom
        });
      } catch (err) {
        console.error('‚ùå Error handling offer from', from, ':', err);
        status.textContent = `–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–ø—Ä–æ—Å–∞ –æ—Ç ${from}`;
        status.className = 'status error';
      }
    });

    socket.on('answer', async ({ answer, from }) => {
      const pc = peerConnections[from];
      if (!pc) {
        console.warn(`No peer connection found for ${from} when receiving answer`);
        return;
      }

      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–ª–∏ –ª–∏ –º—ã —É–∂–µ —ç—Ç–æ—Ç answer
      const answerId = `${from}-${answer.sdp.substring(0, 50)}`;
      if (processedAnswers.has(answerId)) {
        console.log(`Answer from ${from} already processed, skipping`);
        return;
      }

      try {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–µ—Ä–µ–¥ —É—Å—Ç–∞–Ω–æ–≤–∫–æ–π
        const currentState = pc.signalingState;
        console.log(`Received answer from ${from}, current state:`, currentState);
        
        if (currentState === 'have-local-offer') {
          console.log(`Setting remote answer from ${from}...`);
          await pc.setRemoteDescription(new RTCSessionDescription(answer));
          processedAnswers.add(answerId);
          console.log(`‚úÖ Remote answer set successfully, new state:`, pc.signalingState);
        } else if (currentState === 'have-remote-answer' || currentState === 'stable') {
          console.log(`Answer already processed for ${from}, state:`, currentState);
        } else {
          console.warn(`Cannot set remote answer, wrong state:`, currentState);
        }
      } catch (err) {
        // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ –µ—Å–ª–∏ —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ
        if (err.message && err.message.includes('stable')) {
          console.log(`Answer already set for ${from} (stable state)`);
        } else if (err.message && err.message.includes('have-remote-answer')) {
          console.log(`Answer already set for ${from} (have-remote-answer state)`);
        } else {
          console.error('Error setting remote description:', err);
        }
      }
    });

    socket.on('ice-candidate', async ({ candidate, from }) => {
      const pc = peerConnections[from];
      if (!pc) {
        console.warn(`‚ùå No peer connection for ${from} when adding ICE candidate`);
        return;
      }

      if (!candidate) {
        console.log(`üìã ICE gathering complete for ${from}`);
        return;
      }

      // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
      if (pc.signalingState === 'closed' || pc.connectionState === 'closed') {
        console.warn(`‚ùå Cannot add ICE candidate, connection closed for ${from}`);
        return;
      }

      try {
        const candidateType = candidate.type || 'unknown';
        console.log(`‚ûï Adding ${candidateType} ICE candidate from ${from}`);
        await pc.addIceCandidate(new RTCIceCandidate(candidate));
        console.log(`‚úÖ ICE candidate added successfully from ${from}`);
      } catch (err) {
        // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –∑–∞–∫—Ä—ã—Ç—ã—Ö —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
        if (err.message && err.message.includes('duplicate')) {
          console.log(`‚ÑπÔ∏è Duplicate ICE candidate from ${from} (ignored)`);
        } else if (err.message && (err.message.includes('closed') || err.message.includes('InvalidStateError'))) {
          console.log(`‚ÑπÔ∏è ICE candidate from closed connection ${from} (ignored)`);
        } else {
          console.error('‚ùå Error adding ICE candidate from', from, ':', err);
        }
      }
    });

    socket.on('message', ({ userId, name, message, timestamp }) => {
      const messageDiv = document.createElement('div');
      messageDiv.className = 'message';
      
      const time = new Date(timestamp).toLocaleTimeString('ru-RU', { 
        hour: '2-digit', 
        minute: '2-digit' 
      });
      
      messageDiv.innerHTML = `
        <div class="message-avatar">${name[0].toUpperCase()}</div>
        <div class="message-content">
          <div class="message-header">
            <span class="message-author">${name}</span>
            <span class="message-time">${time}</span>
          </div>
          <div class="message-text">${message}</div>
        </div>
      `;
      
      messages.appendChild(messageDiv);
      messages.scrollTop = messages.scrollHeight;
    });

    socket.on('connect', () => {
      console.log('–ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ —Å–µ—Ä–≤–µ—Ä—É');
      currentUserId = socket.id; // –°–æ—Ö—Ä–∞–Ω—è–µ–º ID —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
      debugLog('Current user ID:', currentUserId);
      if (status.className.includes('error')) {
        status.textContent = '–ü–æ–¥–∫–ª—é—á–µ–Ω–æ';
        status.className = 'status connected';
      }
    });

    socket.on('disconnect', () => {
      status.textContent = '–û—Ç–∫–ª—é—á–µ–Ω–æ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞';
      status.className = 'status error';
    });

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ç–æ—Ä–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    setInterval(() => {
      // –û–±–Ω–æ–≤–ª—è–µ–º –≤–∏–∑—É–∞–ª–∏–∑–∞—Ç–æ—Ä—ã –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å –∞–∫—Ç–∏–≤–Ω—ã–º–∏ –∞–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä–∞–º–∏
      Object.keys(remoteAnalysers).forEach(userId => {
        const audio = remoteAudios[userId];
        const analyser = remoteAnalysers[userId];

        if (analyser && visualizers[userId]) {
          // –û–±–Ω–æ–≤–ª—è–µ–º –µ—Å–ª–∏ –∞—É–¥–∏–æ –∏–≥—Ä–∞–µ—Ç –∏–ª–∏ –≥–æ—Ç–æ–≤–æ –∫ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—é
          if (audio && (audio.readyState >= 2 || !audio.paused)) {
            updateUserVisualizer(userId);
          } else {
            // –ï—Å–ª–∏ –∞—É–¥–∏–æ –Ω–µ –∏–≥—Ä–∞–µ—Ç, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –±–∞—Ä—ã
            const bars = visualizers[userId].querySelectorAll('.user-bar');
            if (bars && bars.length > 0) {
              bars.forEach(bar => {
                bar.style.height = '1px';
                bar.style.background = '#72767d';
              });
            }
          }
        }
      });

      // –¢–∞–∫–∂–µ –æ–±–Ω–æ–≤–ª—è–µ–º –≤–∏–∑—É–∞–ª–∏–∑–∞—Ç–æ—Ä—ã, –∫–æ—Ç–æ—Ä—ã–µ –µ—â–µ –Ω–µ –∏–º–µ—é—Ç –∞–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä–∞ (–ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—É—Å—Ç—ã–µ –±–∞—Ä—ã)
      Object.keys(visualizers).forEach(userId => {
        if (!remoteAnalysers[userId] && visualizers[userId]) {
          const bars = visualizers[userId].querySelectorAll('.user-bar');
          if (bars && bars.length > 0) {
            bars.forEach(bar => {
              bar.style.height = '1px';
              bar.style.background = '#72767d';
            });
          }
        }
      });
    }, 100);

    // –û—Ç–ª–∞–¥–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥
    if (DEBUG) {
      setInterval(() => {
        const connections = Object.keys(peerConnections);
        if (connections.length > 0) {
          debugLog('üìä Connection status:');
          connections.forEach(userId => {
            const pc = peerConnections[userId];
            if (pc) {
              debugLog(`   ${userId}: ICE=${pc.iceConnectionState}, Signaling=${pc.signalingState}`);
            }
          });
        }
      }, 5000);
    }
</script>
</body>
</html>
