<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Voice Room</title>
<style>
body { font-family: Arial; background:#0f172a; color:#e5e7eb; display:flex; justify-content:center; align-items:center; height:100vh; margin:0; }
.app { width:550px; background:#020617; border-radius:16px; padding:20px; box-shadow:0 0 40px rgba(0,0,0,.6); }
h1 { text-align:center; margin-top:0; }
#login .controls { display:flex; gap:10px; margin-top:10px; }
#login input { flex:2; padding:10px; border-radius:8px; border:none; font-size:16px; }
#login button { flex:1; border-radius:8px; border:none; font-size:16px; background:#2563eb; color:white; cursor:pointer; }
#login button:hover { background:#1d4ed8; }
.hidden { display:none; }
.layout { display:grid; grid-template-columns:1fr 1fr; gap:10px; }
.box { background:#020617; border:1px solid #1e293b; border-radius:10px; padding:10px; height:200px; overflow-y:auto; }
.user { display:flex; align-items:center; margin-bottom:5px; font-size:14px; }
.indicator { width:60px; height:10px; background:#555; margin-right:5px; border-radius:5px; overflow:hidden; }
.level { height:100%; background:#16a34a; width:0%; transition:width 0.05s; }
.controls { display:flex; gap:10px; margin-top:10px; }
.volume-slider { width:80px; }
</style>
</head>
<body>
<div class="app">
<h1>ðŸŽ§ Voice Room</h1>

<div id="login">
  <input id="name" placeholder="Ð¢Ð²Ð¾Ñ‘ Ð¸Ð¼Ñ" />
  <div class="controls">
    <button onclick="joinRoom()">Ð’Ð¾Ð¹Ñ‚Ð¸ Ð² ÐºÐ¾Ð¼Ð½Ð°Ñ‚Ñƒ</button>
  </div>
</div>

<div id="room" class="hidden">
  <div class="layout">
    <div class="box" id="users"></div>
    <div class="box" id="messages"></div>
  </div>
  <input id="msg" placeholder="Ð¡Ð¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ" onkeydown="if(event.key==='Enter') send()" />
  <div class="controls">
    <button onclick="send()">ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÑŒ</button>
    <button onclick="leaveRoom()">Ð’Ñ‹Ð¹Ñ‚Ð¸ Ð¸Ð· ÐºÐ¾Ð¼Ð½Ð°Ñ‚Ñ‹</button>
    <button id="noiseBtn">Ð¨ÑƒÐ¼Ð¾Ð¿Ð¾Ð´Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ: Ð’ÐºÐ»</button>
  </div>
</div>
</div>

<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<script>
let socket, name, localStream, peers = {}, audioElements = {}, audioAnalyzers = {};
let noiseSuppression = true;
const usersDiv = document.getElementById('users');
const messages = document.getElementById('messages');
const msg = document.getElementById('msg');

document.getElementById('noiseBtn').onclick = () => {
  noiseSuppression = !noiseSuppression;
  if(localStream) localStream.getAudioTracks()[0].applyConstraints({ noiseSuppression });
  document.getElementById('noiseBtn').innerText = `Ð¨ÑƒÐ¼Ð¾Ð¿Ð¾Ð´Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ: ${noiseSuppression?'Ð’ÐºÐ»':'Ð’Ñ‹ÐºÐ»'}`;
};

async function joinRoom() {
  name = document.getElementById('name').value.trim();
  if(!name) return alert('Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ Ð¸Ð¼Ñ');
  document.getElementById('login').classList.add('hidden');
  document.getElementById('room').classList.remove('hidden');

  socket = io('https://voice-server-w83t.onrender.com');
  localStream = await navigator.mediaDevices.getUserMedia({ audio:{ noiseSuppression } });

  // Ð­ÐºÐ²Ð°Ð»Ð°Ð¹Ð·ÐµÑ€ Ð»Ð¾ÐºÐ°Ð»ÑŒÐ½Ð¾Ð³Ð¾ Ð¼Ð¸ÐºÑ€Ð¾Ñ„Ð¾Ð½Ð°
  const audioCtx = new AudioContext();
  const localSource = audioCtx.createMediaStreamSource(localStream);
  const analyserLocal = audioCtx.createAnalyser();
  localSource.connect(analyserLocal);
  analyserLocal.fftSize = 256;
  const dataArrayLocal = new Uint8Array(analyserLocal.frequencyBinCount);
  setInterval(()=>{
    analyserLocal.getByteFrequencyData(dataArrayLocal);
    const vol = dataArrayLocal.reduce((a,b)=>a+b,0)/dataArrayLocal.length;
    const levelEl = document.getElementById(`level_${name}`);
    if(levelEl) levelEl.style.width = Math.min(100, vol*2)+'%';
  },50);

  socket.emit('join', name);

  socket.on('users', usersList=>{
    usersDiv.innerHTML='';
    usersList.forEach(u=>{
      if(!audioElements[u]) {
        const div = document.createElement('div');
        div.className='user';
        div.id=`user_${u}`;
        div.innerHTML=`<div class='indicator'><div class='level' id='level_${u}'></div></div> ${u}`;
        usersDiv.appendChild(div);
      }
      if(u!==name && !peers[u]) createPeer(u, true);
    });
  });

  socket.on('message', m=>{
    messages.innerHTML+=`<div><b>${m.name}:</b> ${m.text}</div>`;
    messages.scrollTop = messages.scrollHeight;
  });

  socket.on('offer', async data=>{
    if(!peers[data.from]) createPeer(data.from, false, data.offer);
  });

  socket.on('answer', async data=>{
    await peers[data.from].setRemoteDescription(data.answer);
  });

  socket.on('ice', async data=>{
    if(peers[data.from]) await peers[data.from].addIceCandidate(data.candidate);
  });
}

function createPeer(userId, isInitiator, offer=null){
  const pc = new RTCPeerConnection({ iceServers:[{ urls:'stun:stun.l.google.com:19302' }] });
  peers[userId] = pc;
  localStream.getTracks().forEach(track=>pc.addTrack(track, localStream));

  pc.onicecandidate = e=>{
    if(e.candidate) socket.emit('ice',{ candidate:e.candidate, to:userId, from:name });
  };

  pc.ontrack = e=>{
    if(!audioElements[userId]){
      const audioEl = document.createElement('audio');
      audioEl.srcObject = e.streams[0];
      audioEl.autoplay = true;
      audioElements[userId] = audioEl;
      document.body.appendChild(audioEl);

      const audioCtx = new AudioContext();
      const analyser = audioCtx.createAnalyser();
      const src = audioCtx.createMediaStreamSource(e.streams[0]);
      src.connect(analyser);
      analyser.fftSize=256;
      audioAnalyzers[userId] = analyser;
      const dataArr = new Uint8Array(analyser.frequencyBinCount);
      setInterval(()=>{
        analyser.getByteFrequencyData(dataArr);
        const vol = dataArr.reduce((a,b)=>a+b,0)/dataArr.length;
        const levelEl = document.getElementById(`level_${userId}`);
        if(levelEl) levelEl.style.width = Math.min(100, vol*2)+'%';
      },50);
    }
  };

  if(isInitiator){
    pc.createOffer().then(offer=>{
      pc.setLocalDescription(offer);
      socket.emit('offer',{ offer, to:userId, from:name });
    });
  } else if(offer){
    pc.setRemoteDescription(offer).then(async ()=>{
      const answer = await pc.createAnswer();
      await pc.setLocalDescription(answer);
      socket.emit('answer',{ answer, to:userId, from:name });
    });
  }
}

function send(){ const text=msg.value.trim(); if(!text) return; socket.emit('message',{name,text}); msg.value=''; }

function leaveRoom(){
  for(let p in peers) peers[p].close();
  peers={};
  if(localStream) localStream.getTracks().forEach(t=>t.stop());
  audioElements={};
  audioAnalyzers={};
  socket.disconnect();
  document.getElementById('room').classList.add('hidden');
  document.getElementById('login').classList.remove('hidden');
  messages.innerHTML='';
  usersDiv.innerHTML='';
}
</script>
</body>
</html>
